<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Books | Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="dark-mode transition-colors duration-500 overflow-x-hidden">

    <div class="nebula-bg"></div>
    <div class="glow-mesh"></div>

    <nav class="fixed top-6 w-full z-[1050] px-4">
        <div class="container mx-auto max-w-6xl">
            <div class="navbar-glass flex items-center justify-between px-8 py-3 rounded-[100px] border border-white/10 shadow-2xl backdrop-blur-2xl">
                <a class="flex items-center gap-3 no-underline" href="admin.html">
                    <div class="brand-box">üìö</div>
                    <span class="brand-text text-xl font-extrabold tracking-tighter uppercase">Library Assets</span>
                </a>
                <div class="flex items-center gap-3">
                    <button onclick="toggleMode()" class="utility-btn" id="modeToggle">
                        <span id="themeIcon">‚òÄÔ∏è</span>
                    </button>
                    <a href="admin.html" class="btn-galaxy px-4 py-2 text-sm no-underline">‚Üê Dashboard</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container py-32">
        <div class="cyber-modal p-5 shadow-2xl mb-12">
            <div class="mb-5">
                <h2 class="fw-bold tracking-tight m-0">Publish <span class="text-violet-400">Content</span></h2>
                <p class="opacity-50 small mt-1">Add new digital titles to the universal library archive</p>
            </div>

            <form id="bookForm">
                <input type="hidden" id="editBookId">
                <div class="row g-4">
                    <div class="col-md-4">
                        <label class="small opacity-50 uppercase tracking-widest fw-bold mb-2 d-block">Book Title</label>
                        <input type="text" id="title" class="cyber-input" placeholder="e.g. Cosmic Horizons" required>
                    </div>
                    <div class="col-md-4">
                        <label class="small opacity-50 uppercase tracking-widest fw-bold mb-2 d-block">Author Name</label>
                        <input type="text" id="author" class="cyber-input" placeholder="e.g. Dr. Orion" required>
                    </div>
                    <div class="col-md-4">
                        <label class="small opacity-50 uppercase tracking-widest fw-bold mb-2 d-block">Price (INR)</label>
                        <input type="number" id="price" class="cyber-input" value="0">
                    </div>
                    <div class="col-md-5">
                        <label class="small opacity-50 uppercase tracking-widest fw-bold mb-2 d-block">Cover Image URL</label>
                        <input type="url" id="cover_url" class="cyber-input" placeholder="https://..." required>
                    </div>
                    <div class="col-md-5">
                        <label class="small opacity-50 uppercase tracking-widest fw-bold mb-2 d-block">PDF / Access Link</label>
                        <input type="url" id="book_url" class="cyber-input" placeholder="https://..." required>
                    </div>
                    <div class="col-md-2">
                        <label class="small opacity-50 uppercase tracking-widest fw-bold mb-2 d-block">Tier</label>
                        <select id="is_free" class="cyber-input">
                            <option value="1">Free Access</option>
                            <option value="0">Premium Only</option>
                        </select>
                    </div>
                    <div class="col-12 text-end mt-4">
                        <button type="submit" id="submitBtn" class="btn-galaxy px-5 py-3">Publish to Vault</button>
                    </div>
                </div>
            </form>
        </div>

        <div class="cyber-modal p-5 shadow-2xl">
            <h4 class="fw-bold mb-5 tracking-tight flex items-center gap-2">
                <span class="text-violet-500">üìñ</span> Planetary Collection
            </h4>
            
            <div class="table-responsive">
                <table class="table table-custom">
                    <thead>
                        <tr>
                            <th>Preview</th>
                            <th>Title & Author</th>
                            <th>Access Tier</th>
                            <th>Cost</th>
                            <th class="text-end">Command</th>
                        </tr>
                    </thead>
                    <tbody id="bookTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = "http://localhost:5000/api";

        // --- THEME SYNC ---
        function applySavedTheme() {
            const savedTheme = localStorage.getItem('themePreference');
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                document.getElementById('themeIcon').innerText = 'üåô';
            }
        }

        function toggleMode() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            body.classList.toggle('light-mode');
            if (body.classList.contains('light-mode')) {
                themeIcon.innerText = 'üåô';
                localStorage.setItem('themePreference', 'light');
            } else {
                themeIcon.innerText = '‚òÄÔ∏è';
                localStorage.setItem('themePreference', 'dark');
            }
        }

        let globalBooks = [];

        // --- 1. Load Books ---
        async function loadBooks() {
            try {
                const res = await fetch(`${API_BASE}/books`);
                globalBooks = await res.json();
                document.getElementById('bookTableBody').innerHTML = globalBooks.map(b => `
                    <tr>
                        <td style="width: 80px;">
                            <div class="book-preview-container">
                                <img src="${b.cover_url}" class="book-preview-img shadow-lg">
                            </div>
                        </td>
                        <td>
                            <div class="fw-bold text-white opacity-90">${b.title}</div>
                            <div class="small opacity-40">${b.author}</div>
                        </td>
                        <td>
                            <span class="status-pill ${b.is_free ? 'active' : 'expired'}" style="font-size: 10px;">
                                ${b.is_free ? '‚óè FREE' : '‚óè PREMIUM'}
                            </span>
                        </td>
                        <td><span class="text-price text-sm">‚Çπ${b.price || 0}</span></td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-info me-2" onclick="editBook(${b.id})">
                                ‚úèÔ∏è Edit
                            </button>
                            <button class="btn-delete-cyber" onclick="deleteBook(${b.id})">
                                <span>Purge</span>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) { console.error("Archive sync failed", err); }
        }

        // --- 2. Add / Edit Book ---
        document.getElementById('bookForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerText;
            btn.innerText = "Processing...";
            btn.disabled = true;
            const editId = document.getElementById('editBookId').value;

            const bookData = {
                title: document.getElementById('title').value,
                author: document.getElementById('author').value,
                cover_url: document.getElementById('cover_url').value,
                book_url: document.getElementById('book_url').value,
                price: document.getElementById('price').value,
                is_free: document.getElementById('is_free').value
            };

            const url = editId ? `${API_BASE}/admin/update-book/${editId}` : `${API_BASE}/admin/add-book`;
            const method = editId ? 'PUT' : 'POST';

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(bookData)
                });
                const data = await res.json();
                if(data.success) {
                    alert(editId ? "System: Content updated." : "System: Content successfully published.");
                    document.getElementById('bookForm').reset();
                    document.getElementById('editBookId').value = "";
                    document.getElementById('submitBtn').innerText = "Publish to Vault";
                    loadBooks();
                }
            } catch (err) { alert("Uplink failed."); }
            finally {
                if(!editId) btn.innerText = "Publish to Vault";
                btn.disabled = false;
            }
        });

        function editBook(id) {
            const book = globalBooks.find(b => b.id == id);
            if(book) {
                document.getElementById('editBookId').value = book.id;
                document.getElementById('title').value = book.title;
                document.getElementById('author').value = book.author;
                document.getElementById('cover_url').value = book.cover_url;
                document.getElementById('book_url').value = book.book_url;
                document.getElementById('price').value = book.price;
                document.getElementById('is_free').value = book.is_free;
                
                document.getElementById('submitBtn').innerText = "Update Content";
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // --- 3. Delete Book ---
        async function deleteBook(id) {
            if(!confirm("Are you sure you want to purge this record?")) return;
            const res = await fetch(`${API_BASE}/admin/delete-book/${id}`, { method: 'DELETE' });
            if(res.ok) {
                loadBooks();
            }
        }

        window.onload = () => {
            applySavedTheme();
            loadBooks();
        };
    </script>
</body>
</html>